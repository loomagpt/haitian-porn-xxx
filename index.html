<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StreamFlix - Video Sharing Platform</title>
    <!-- Fluid Player -->
    <link rel="stylesheet" href="https://cdn.fluidplayer.com/v3/current/fluidplayer.min.css">
    <script src="https://cdn.fluidplayer.com/v3/current/fluidplayer.min.js"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <!-- Firebase Auth -->
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-analytics-compat.js"></script>
    <!-- Back4App/Parse -->
    <script src="https://npmcdn.com/parse/dist/parse.min.js"></script>
    <style>
        /* CSS Reset & Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-color: #ff0000;
            --primary-dark: #cc0000;
            --secondary-color: #065fd4;
            --dark-bg: #0f0f0f;
            --dark-surface: #212121;
            --dark-surface-light: #3d3d3d;
            --dark-text: #f1f1f1;
            --dark-text-secondary: #aaa;
            --light-bg: #ffffff;
            --light-surface: #f9f9f9;
            --light-surface-dark: #f1f1f1;
            --light-text: #030303;
            --light-text-secondary: #606060;
            --shadow: 0 1px 2px rgba(0,0,0,0.1);
            --shadow-lg: 0 4px 8px rgba(0,0,0,0.2);
            --border-radius: 12px;
            --transition: all 0.3s ease;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--light-bg);
            color: var(--light-text);
            transition: var(--transition);
            overflow-x: hidden;
        }

        body.dark-mode {
            background-color: var(--dark-bg);
            color: var(--dark-text);
        }

        .hidden {
            display: none !important;
        }

        /* Header Styles */
        header {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 56px;
            padding: 0 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            background-color: var(--light-bg);
            box-shadow: var(--shadow);
            z-index: 1000;
            transition: var(--transition);
        }

        body.dark-mode header {
            background-color: var(--dark-bg);
            box-shadow: 0 1px 2px rgba(0,0,0,0.5);
        }

        .logo-container {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .logo-icon {
            color: var(--primary-color);
            font-size: 28px;
        }

        .logo-text {
            font-size: 20px;
            font-weight: 700;
            color: var(--light-text);
        }

        body.dark-mode .logo-text {
            color: var(--dark-text);
        }

        .search-container {
            flex: 1;
            max-width: 600px;
            margin: 0 40px;
            display: flex;
        }

        .search-input {
            width: 100%;
            padding: 10px 16px;
            border: 1px solid #ccc;
            border-radius: 20px 0 0 20px;
            font-size: 16px;
            background-color: var(--light-bg);
            color: var(--light-text);
            transition: var(--transition);
        }

        body.dark-mode .search-input {
            background-color: var(--dark-surface);
            color: var(--dark-text);
            border-color: var(--dark-surface-light);
        }

        .search-button {
            padding: 10px 20px;
            background-color: var(--light-surface-dark);
            border: 1px solid #ccc;
            border-left: none;
            border-radius: 0 20px 20px 0;
            cursor: pointer;
            transition: var(--transition);
        }

        body.dark-mode .search-button {
            background-color: var(--dark-surface-light);
            border-color: var(--dark-surface-light);
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .icon-button {
            background: none;
            border: none;
            font-size: 20px;
            color: var(--light-text);
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            transition: var(--transition);
        }

        body.dark-mode .icon-button {
            color: var(--dark-text);
        }

        .icon-button:hover {
            background-color: rgba(0,0,0,0.1);
        }

        body.dark-mode .icon-button:hover {
            background-color: rgba(255,255,255,0.1);
        }

        .upload-button {
            padding: 8px 16px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 20px;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
        }

        .upload-button:hover {
            background-color: var(--primary-dark);
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background-color: var(--secondary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 500;
            cursor: pointer;
        }

        /* Main Layout */
        .main-container {
            display: flex;
            margin-top: 56px;
            min-height: calc(100vh - 56px);
        }

        /* Sidebar */
        .sidebar {
            width: 240px;
            background-color: var(--light-bg);
            padding: 12px 0;
            overflow-y: auto;
            position: fixed;
            top: 56px;
            left: 0;
            height: calc(100vh - 56px);
            transition: var(--transition);
            z-index: 999;
        }

        body.dark-mode .sidebar {
            background-color: var(--dark-bg);
        }

        .sidebar-item {
            display: flex;
            align-items: center;
            gap: 24px;
            padding: 12px 24px;
            cursor: pointer;
            transition: var(--transition);
            color: var(--light-text);
        }

        body.dark-mode .sidebar-item {
            color: var(--dark-text);
        }

        .sidebar-item:hover {
            background-color: rgba(0,0,0,0.05);
        }

        body.dark-mode .sidebar-item:hover {
            background-color: rgba(255,255,255,0.05);
        }

        .sidebar-item.active {
            background-color: rgba(0,0,0,0.1);
            font-weight: 500;
        }

        body.dark-mode .sidebar-item.active {
            background-color: rgba(255,255,255,0.1);
        }

        .sidebar-icon {
            font-size: 20px;
            width: 24px;
            text-align: center;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: 240px;
            padding: 20px;
            transition: var(--transition);
        }

        /* View Container */
        .view-container {
            min-height: calc(100vh - 96px);
        }

        /* Home View */
        .videos-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .video-card {
            background-color: var(--light-bg);
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--shadow);
            transition: var(--transition);
            cursor: pointer;
        }

        body.dark-mode .video-card {
            background-color: var(--dark-surface);
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .video-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }

        .video-thumbnail {
            width: 100%;
            height: 160px;
            object-fit: cover;
            background-color: #ddd;
            position: relative;
        }

        body.dark-mode .video-thumbnail {
            background-color: #333;
        }

        .video-info {
            padding: 12px;
        }

        .video-title {
            font-weight: 500;
            margin-bottom: 8px;
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            height: 40px;
        }

        .video-creator {
            font-size: 14px;
            color: var(--light-text-secondary);
            margin-bottom: 4px;
        }

        body.dark-mode .video-creator {
            color: var(--dark-text-secondary);
        }

        .video-stats {
            font-size: 14px;
            color: var(--light-text-secondary);
            display: flex;
            gap: 8px;
        }

        body.dark-mode .video-stats {
            color: var(--dark-text-secondary);
        }

        /* Loading State */
        .loading-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--light-text-secondary);
            display: none;
        }

        body.dark-mode .loading-state {
            color: var(--dark-text-secondary);
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(0,0,0,0.1);
            border-radius: 50%;
            border-top-color: var(--primary-color);
            animation: spin 1s ease-in-out infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Authentication Views */
        .auth-container {
            max-width: 400px;
            margin: 40px auto;
            padding: 30px;
            background-color: var(--light-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-lg);
        }

        body.dark-mode .auth-container {
            background-color: var(--dark-surface);
        }

        .auth-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .auth-header h2 {
            font-size: 24px;
            margin-bottom: 8px;
        }

        .auth-form {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-label {
            font-weight: 500;
        }

        .form-input {
            padding: 12px 16px;
            border: 1px solid #ccc;
            border-radius: 8px;
            font-size: 16px;
            transition: var(--transition);
            background-color: var(--light-bg);
            color: var(--light-text);
        }

        body.dark-mode .form-input {
            background-color: var(--dark-surface);
            color: var(--dark-text);
            border-color: var(--dark-surface-light);
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .auth-button {
            padding: 12px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            margin-top: 10px;
        }

        .auth-button:hover {
            background-color: var(--primary-dark);
        }

        .auth-footer {
            text-align: center;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #ddd;
        }

        body.dark-mode .auth-footer {
            border-top-color: var(--dark-surface-light);
        }

        .auth-link {
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 500;
            cursor: pointer;
        }

        .auth-link:hover {
            text-decoration: underline;
        }

        /* Upload View */
        .upload-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        .upload-area {
            border: 2px dashed #ccc;
            border-radius: var(--border-radius);
            padding: 40px 20px;
            text-align: center;
            margin-bottom: 30px;
            transition: var(--transition);
            cursor: pointer;
        }

        body.dark-mode .upload-area {
            border-color: var(--dark-surface-light);
        }

        .upload-area.drag-over {
            border-color: var(--primary-color);
            background-color: rgba(255, 0, 0, 0.05);
        }

        .upload-icon {
            font-size: 60px;
            color: var(--primary-color);
            margin-bottom: 20px;
        }

        .upload-input {
            display: none;
        }

        /* Video Player */
        .video-player-container {
            background-color: #000;
            border-radius: var(--border-radius);
            overflow: hidden;
            margin-bottom: 20px;
            position: relative;
            padding-top: 56.25%; /* 16:9 Aspect Ratio */
        }

        .video-player-container iframe,
        .video-player-container video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: none;
        }

        .fluid-player-container {
            position: absolute !important;
            top: 0 !important;
            left: 0 !important;
            width: 100% !important;
            height: 100% !important;
        }

        /* Video Detail */
        .video-detail-container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .video-info-detail {
            background-color: var(--light-surface);
            padding: 20px;
            border-radius: var(--border-radius);
            margin-top: 20px;
        }

        body.dark-mode .video-info-detail {
            background-color: var(--dark-surface);
        }

        .video-title-detail {
            font-size: 20px;
            margin-bottom: 12px;
        }

        .video-meta {
            color: var(--light-text-secondary);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        body.dark-mode .video-meta {
            color: var(--dark-text-secondary);
        }

        .video-actions {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .action-button {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background-color: var(--light-surface-dark);
            border: none;
            border-radius: 20px;
            color: var(--light-text);
            cursor: pointer;
            transition: var(--transition);
            font-size: 14px;
        }

        body.dark-mode .action-button {
            background-color: var(--dark-surface-light);
            color: var(--dark-text);
        }

        .action-button:hover {
            background-color: rgba(0,0,0,0.1);
        }

        body.dark-mode .action-button:hover {
            background-color: rgba(255,255,255,0.1);
        }

        .action-button.active {
            background-color: var(--primary-color);
            color: white;
        }

        .action-button.active.like {
            background-color: #065fd4;
        }

        .action-button.active.dislike {
            background-color: #606060;
        }

        .creator-info-detail {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
        }

        body.dark-mode .creator-info-detail {
            border-bottom-color: var(--dark-surface-light);
        }

        .creator-avatar-small {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 500;
            font-size: 20px;
            color: white;
            background-color: var(--secondary-color);
        }

        .creator-details {
            flex: 1;
        }

        .creator-details h3 {
            margin-bottom: 4px;
        }

        .creator-details p {
            color: var(--light-text-secondary);
            font-size: 14px;
        }

        body.dark-mode .creator-details p {
            color: var(--dark-text-secondary);
        }

        .subscribe-button {
            padding: 10px 20px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 20px;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
        }

        .subscribe-button:hover {
            background-color: var(--primary-dark);
        }

        .video-description {
            background-color: var(--light-surface-dark);
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            white-space: pre-line;
        }

        body.dark-mode .video-description {
            background-color: var(--dark-surface);
        }

        /* Comments */
        .comments-section {
            background-color: var(--light-surface);
            padding: 20px;
            border-radius: var(--border-radius);
            margin-top: 20px;
        }

        body.dark-mode .comments-section {
            background-color: var(--dark-surface);
        }

        .comment-input {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
        }

        .user-avatar-small {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--secondary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 500;
        }

        .comment-input input {
            flex: 1;
            padding: 10px 16px;
            border: 1px solid #ccc;
            border-radius: 20px;
            background-color: var(--light-bg);
            color: var(--light-text);
        }

        body.dark-mode .comment-input input {
            background-color: var(--dark-surface);
            color: var(--dark-text);
            border-color: var(--dark-surface-light);
        }

        .comment-button {
            padding: 10px 20px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
        }

        .comment {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
        }

        .comment-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #666;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 500;
        }

        .comment-content {
            flex: 1;
        }

        .comment-content h4 {
            margin-bottom: 4px;
        }

        .comment-content p {
            margin-bottom: 8px;
            color: var(--light-text);
            white-space: pre-line;
        }

        body.dark-mode .comment-content p {
            color: var(--dark-text);
        }

        .comment-actions {
            display: flex;
            gap: 16px;
        }

        .comment-actions button {
            background: none;
            border: none;
            color: var(--light-text-secondary);
            cursor: pointer;
            font-size: 14px;
        }

        body.dark-mode .comment-actions button {
            color: var(--dark-text-secondary);
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
                width: 280px;
            }
            
            .sidebar.active {
                transform: translateX(0);
            }
            
            .main-content {
                margin-left: 0;
            }
            
            .search-container {
                margin: 0 10px;
            }
            
            .videos-grid {
                grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
            }
            
            .modal-actions {
                flex-direction: column;
            }
            
            .video-actions {
                justify-content: center;
            }
            
            .video-player-container {
                margin-left: -20px;
                margin-right: -20px;
                border-radius: 0;
                padding-top: 56.25%;
            }
        }

        /* Mobile Menu Button */
        .menu-button {
            display: none;
            background: none;
            border: none;
            font-size: 20px;
            color: var(--light-text);
            cursor: pointer;
            padding: 8px;
        }

        body.dark-mode .menu-button {
            color: var(--dark-text);
        }

        @media (max-width: 768px) {
            .menu-button {
                display: block;
            }
        }

        /* Toast Notifications */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 16px 24px;
            background-color: var(--light-surface);
            color: var(--light-text);
            border-radius: 8px;
            box-shadow: var(--shadow-lg);
            z-index: 3000;
            display: flex;
            align-items: center;
            gap: 12px;
            transform: translateY(100px);
            opacity: 0;
            transition: transform 0.3s ease, opacity 0.3s ease;
        }

        body.dark-mode .toast {
            background-color: var(--dark-surface);
            color: var(--dark-text);
        }

        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }

        .toast-success {
            border-left: 4px solid #4caf50;
        }

        .toast-error {
            border-left: 4px solid #f44336;
        }

        .toast-info {
            border-left: 4px solid #2196f3;
        }

        /* Related Videos */
        .related-videos {
            margin-top: 30px;
        }

        .related-video-card {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
            cursor: pointer;
        }

        .related-thumbnail {
            width: 160px;
            height: 90px;
            border-radius: 8px;
            background-color: #ddd;
            position: relative;
            flex-shrink: 0;
        }

        body.dark-mode .related-thumbnail {
            background-color: #333;
        }

        .related-info {
            flex: 1;
        }

        .related-info h4 {
            font-size: 14px;
            margin-bottom: 4px;
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }

        .related-info p {
            font-size: 12px;
            color: var(--light-text-secondary);
        }

        body.dark-mode .related-info p {
            color: var(--dark-text-secondary);
        }

        /* Upload Progress */
        .upload-progress-container {
            margin-top: 20px;
            display: none;
        }

        .upload-progress {
            width: 100%;
            height: 20px;
            background-color: #eee;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .upload-progress-bar {
            height: 100%;
            background-color: var(--primary-color);
            width: 0%;
            transition: width 0.3s ease;
            position: relative;
        }

        .progress-text {
            text-align: center;
            font-size: 14px;
            color: var(--light-text-secondary);
        }

        body.dark-mode .progress-text {
            color: var(--dark-text-secondary);
        }

        .upload-success {
            text-align: center;
            padding: 20px;
            background-color: #d4edda;
            border-radius: 8px;
            margin-top: 20px;
            display: none;
        }

        body.dark-mode .upload-success {
            background-color: #155724;
            color: white;
        }

        /* Thumbnail Options */
        .thumbnail-options {
            display: flex;
            gap: 20px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .thumbnail-option {
            flex: 1;
            min-width: 300px;
            border: 1px solid #ccc;
            border-radius: var(--border-radius);
            padding: 20px;
            text-align: center;
            transition: var(--transition);
            cursor: pointer;
        }

        body.dark-mode .thumbnail-option {
            border-color: var(--dark-surface-light);
        }

        .thumbnail-option:hover {
            border-color: var(--primary-color);
            transform: translateY(-2px);
        }

        .thumbnail-option.active {
            border-color: var(--primary-color);
            background-color: rgba(255, 0, 0, 0.05);
        }

        .thumbnail-option-icon {
            font-size: 40px;
            color: var(--primary-color);
            margin-bottom: 10px;
        }

        .thumbnail-upload-area {
            border: 2px dashed #ccc;
            border-radius: var(--border-radius);
            padding: 20px;
            text-align: center;
            margin-top: 10px;
            cursor: pointer;
            transition: var(--transition);
        }

        body.dark-mode .thumbnail-upload-area {
            border-color: var(--dark-surface-light);
        }

        .thumbnail-upload-area:hover {
            border-color: var(--primary-color);
        }

        .thumbnail-preview {
            max-width: 100%;
            max-height: 200px;
            margin-top: 10px;
            border-radius: 8px;
            display: none;
        }

        /* Quality Selector */
        .quality-selector {
            position: relative;
            display: inline-block;
        }

        .quality-dropdown {
            display: none;
            position: absolute;
            background-color: var(--light-bg);
            min-width: 100px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
            z-index: 1;
            border-radius: 8px;
            overflow: hidden;
            top: 100%;
            left: 0;
        }

        body.dark-mode .quality-dropdown {
            background-color: var(--dark-surface);
            box-shadow: 0 8px 16px rgba(0,0,0,0.3);
        }

        .quality-dropdown.show {
            display: block;
        }

        .quality-option {
            padding: 12px 16px;
            display: block;
            cursor: pointer;
            transition: var(--transition);
            color: var(--light-text);
            text-decoration: none;
        }

        body.dark-mode .quality-option {
            color: var(--dark-text);
        }

        .quality-option:hover {
            background-color: rgba(0,0,0,0.05);
        }

        body.dark-mode .quality-option:hover {
            background-color: rgba(255,255,255,0.05);
        }

        /* Embed Code Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background-color: var(--light-bg);
            padding: 30px;
            border-radius: var(--border-radius);
            max-width: 500px;
            width: 90%;
            box-shadow: var(--shadow-lg);
        }

        body.dark-mode .modal-content {
            background-color: var(--dark-surface);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 500;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--light-text);
        }

        body.dark-mode .close-modal {
            color: var(--dark-text);
        }

        .embed-code {
            width: 100%;
            padding: 12px;
            background-color: var(--light-surface-dark);
            border: 1px solid #ccc;
            border-radius: 8px;
            font-family: monospace;
            resize: vertical;
            margin-bottom: 20px;
            color: var(--light-text);
        }

        body.dark-mode .embed-code {
            background-color: var(--dark-surface);
            color: var(--dark-text);
            border-color: var(--dark-surface-light);
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .modal-button {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: var(--transition);
        }

        .modal-button.primary {
            background-color: var(--primary-color);
            color: white;
        }

        .modal-button.primary:hover {
            background-color: var(--primary-dark);
        }

        .modal-button.secondary {
            background-color: var(--light-surface-dark);
            color: var(--light-text);
        }

        body.dark-mode .modal-button.secondary {
            background-color: var(--dark-surface-light);
            color: var(--dark-text);
        }

        /* Video Preview in Upload */
        #videoPreview {
            width: 100%;
            max-height: 400px;
            border-radius: var(--border-radius);
            background-color: #000;
        }

        /* Responsive adjustments for video actions */
        @media (max-width: 600px) {
            .video-actions {
                gap: 4px;
            }
            
            .action-button {
                padding: 6px 12px;
                font-size: 12px;
            }
            
            .action-button i {
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header>
        <div class="logo-container">
            <button class="menu-button" id="menuButton">
                <i class="fas fa-bars"></i>
            </button>
            <i class="fas fa-play-circle logo-icon"></i>
            <span class="logo-text">Stream Flix</span>
        </div>
        
        <div class="search-container">
            <input type="text" class="search-input" id="searchInput" placeholder="Search videos...">
            <button class="search-button" id="searchButton">
                <i class="fas fa-search"></i>
            </button>
        </div>
        
        <div class="header-actions">
            <button class="icon-button" id="darkModeToggle">
                <i class="fas fa-moon"></i>
            </button>
            <button class="upload-button" id="uploadButton" style="display: none;">Upload</button>
            <div class="user-avatar" id="userAvatar">?</div>
        </div>
    </header>

    <!-- Main Layout -->
    <div class="main-container">
        <!-- Sidebar -->
        <nav class="sidebar" id="sidebar">
            <div class="sidebar-item active" data-view="home">
                <i class="fas fa-home sidebar-icon"></i>
                <span>Home</span>
            </div>
            <div class="sidebar-item" id="loginItem">
                <i class="fas fa-sign-in-alt sidebar-icon"></i>
                <span>Sign In</span>
            </div>
            <div class="sidebar-item" id="logoutItem" style="display: none;">
                <i class="fas fa-sign-out-alt sidebar-icon"></i>
                <span>Log Out</span>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <div class="view-container" id="viewContainer">
                <!-- Home View (Default) -->
                <div class="view" id="homeView">
                    <!-- Loading State (Only shows during initial fetch) -->
                    <div class="loading-state" id="loadingState">
                        <div class="spinner"></div>
                        <h2>Loading videos...</h2>
                        <p>Please wait while we load the latest videos</p>
                    </div>
                    
                    <!-- Videos Grid -->
                    <div class="videos-grid" id="videosGrid">
                        <!-- Videos loaded from Back4App -->
                    </div>
                </div>

                <!-- Video Detail View -->
                <div class="view hidden" id="videoDetailView">
                    <!-- Video will be loaded here -->
                </div>

                <!-- Authentication View -->
                <div class="view hidden" id="authView">
                    <div class="auth-container">
                        <div class="auth-header">
                            <i class="fas fa-play-circle" style="font-size: 48px; color: var(--primary-color); margin-bottom: 16px;"></i>
                            <h2 id="authTitle">Sign In</h2>
                            <p id="authSubtitle">to continue to Stream Flix</p>
                        </div>
                        
                        <form class="auth-form" id="authForm">
                            <div class="form-group">
                                <label class="form-label" for="authEmail">Email</label>
                                <input type="email" class="form-input" id="authEmail" placeholder="Enter your email">
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label" for="authPassword">Password</label>
                                <input type="password" class="form-input" id="authPassword" placeholder="Enter your password">
                            </div>
                            
                            <button type="submit" class="auth-button" id="authSubmitButton">Sign In</button>
                            
                            <div style="text-align: center; margin-top: 20px;">
                                <p style="color: var(--light-text-secondary); margin-bottom: 10px;">Or sign in with</p>
                                <button type="button" class="auth-button" onclick="handleGoogleLogin()" style="background-color: #4285F4;">
                                    <i class="fab fa-google"></i> Google
                                </button>
                            </div>
                        </form>
                        
                        <div class="auth-footer">
                            <p>Don't have an account? <a class="auth-link" id="showSignup">Sign up</a></p>
                        </div>
                        
                        <div class="auth-form hidden" id="signupForm">
                            <div class="form-group">
                                <label class="form-label" for="signupUsername">Username</label>
                                <input type="text" class="form-input" id="signupUsername" placeholder="Choose a username">
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label" for="signupEmail">Email</label>
                                <input type="email" class="form-input" id="signupEmail" placeholder="Enter your email">
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label" for="signupPassword">Password</label>
                                <input type="password" class="form-input" id="signupPassword" placeholder="At least 6 characters">
                            </div>
                            
                            <button type="button" class="auth-button" id="signupButton">Create Account</button>
                        </div>
                    </div>
                </div>

                <!-- Upload View -->
                <div class="view hidden" id="uploadView">
                    <div class="upload-container">
                        <h1>Upload Video</h1>
                        <p>Upload a video to your channel</p>
                        
                        <div class="upload-area" id="uploadArea">
                            <i class="fas fa-cloud-upload-alt upload-icon"></i>
                            <h3>Drag and drop video files</h3>
                            <p>or click to browse files</p>
                            <input type="file" class="upload-input" id="videoUpload" accept="video/*">
                            <p style="margin-top: 20px; font-size: 14px; color: var(--light-text-secondary);">
                                MP4, WebM, or AVI files up to 2GB
                            </p>
                        </div>
                        
                        <!-- Video Preview -->
                        <div class="form-group" id="videoPreviewContainer" style="display: none;">
                            <label class="form-label">Video Preview</label>
                            <video id="videoPreview" controls style="width: 100%; border-radius: var(--border-radius);"></video>
                        </div>
                        
                        <!-- Thumbnail Options -->
                        <div class="form-group" id="thumbnailOptionsContainer" style="display: none;">
                            <label class="form-label">Thumbnail Options</label>
                            <div class="thumbnail-options">
                                <div class="thumbnail-option active" id="autoThumbnailOption">
                                    <i class="fas fa-robot thumbnail-option-icon"></i>
                                    <h3>Generate Thumbnail Automatically</h3>
                                    <p>We'll create a thumbnail from your video</p>
                                    <button type="button" class="auth-button" id="generateThumbnailBtn" style="margin-top: 10px;">
                                        Generate Thumbnail
                                    </button>
                                </div>
                                <div class="thumbnail-option" id="customThumbnailOption">
                                    <i class="fas fa-upload thumbnail-option-icon"></i>
                                    <h3>Upload Custom Thumbnail</h3>
                                    <p>Upload your own thumbnail image</p>
                                    <div class="thumbnail-upload-area" id="thumbnailUploadArea">
                                        <i class="fas fa-image" style="font-size: 30px; margin-bottom: 10px;"></i>
                                        <p>Click to upload thumbnail</p>
                                        <p style="font-size: 12px; color: var(--light-text-secondary);">
                                            JPG, PNG up to 5MB
                                        </p>
                                        <input type="file" id="thumbnailUpload" accept="image/*" style="display: none;">
                                        <img id="thumbnailPreview" class="thumbnail-preview" alt="Thumbnail Preview">
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Video Info -->
                        <div class="form-group" id="videoInfoContainer" style="display: none;">
                            <label class="form-label" for="videoTitle">Video Title</label>
                            <input type="text" class="form-input" id="videoTitle" placeholder="Enter a title for your video">
                        </div>
                        
                        <div class="form-group" id="videoDescContainer" style="display: none;">
                            <label class="form-label" for="videoDescription">Description</label>
                            <textarea class="form-input" id="videoDescription" rows="4" placeholder="Describe your video"></textarea>
                        </div>
                        
                        <!-- Upload Progress -->
                        <div class="upload-progress-container" id="uploadProgressContainer">
                            <div class="upload-progress">
                                <div class="upload-progress-bar" id="uploadProgressBar"></div>
                            </div>
                            <div class="progress-text" id="progressText">0% uploaded</div>
                        </div>
                        
                        <!-- Upload Success Message -->
                        <div class="upload-success" id="uploadSuccess">
                            <i class="fas fa-check-circle" style="font-size: 48px; color: #4caf50; margin-bottom: 16px;"></i>
                            <h3>Video Uploaded Successfully!</h3>
                            <p>Your video is being processed and will be available shortly.</p>
                            <button class="auth-button" onclick="switchView('home')" style="margin-top: 20px;">Go to Home</button>
                        </div>
                        
                        <button class="auth-button" id="submitUpload" style="display: none;">Upload Video</button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Embed Code Modal -->
    <div class="modal" id="embedModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Embed Video</h3>
                <button class="close-modal" onclick="closeEmbedModal()">&times;</button>
            </div>
            <p>Copy and paste this code to embed the video on your website:</p>
            <textarea class="embed-code" id="embedCode" rows="4" readonly></textarea>
            <div class="modal-actions">
                <button class="modal-button secondary" onclick="closeEmbedModal()">Close</button>
                <button class="modal-button primary" onclick="copyEmbedCode()">Copy Code</button>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div class="toast hidden" id="toast">
        <i class="fas fa-info-circle" id="toastIcon"></i>
        <span id="toastMessage">This is a toast message</span>
    </div>

    <script>
        // ============================
        // CONFIGURATION
        // ============================
        
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBsfheLc8i-CsRGJ9jkbGUhdTj3ZD3SLu8",
            authDomain: "haitiantube-2affb.firebaseapp.com",
            projectId: "haitiantube-2affb",
            storageBucket: "haitiantube-2affb.firebasestorage.app",
            messagingSenderId: "564033314604",
            appId: "1:564033314604:web:dfcd9b74b670e47dae1689",
            measurementId: "G-8WS57GK218"
        };
        
        // Back4App/Parse Configuration (UPDATED)
        Parse.initialize("4oDcAZ2ONTyTIaPd5K5WMCYwvaRlJPVPuLhHvv4V", "JvxJd9ziRr1m1wxOoHTXJpuwzLUHuJfo5LtrVaw2");
        Parse.serverURL = 'https://parseapi.back4app.com/';
        
        // Cloudinary Configuration
        const CLOUDINARY_CLOUD_NAME = "dsvfrkt4m";
        const CLOUDINARY_UPLOAD_PRESET = "x0iqhkmr";
        
        // VAST Ads URLs
        const PRE_ROLL_AD_URL = "https://s.magsrv.com/v1/vast.php?idzone=5831138";
        const MID_ROLL_ADS = [
            { time: 30, url: "https://cpm.afkwa.com/vast?zone=283171&tagid=387067" },
            { time: 120, url: "https://s.magsrv.com/v1/vast.php?idzone=5829940" },
            { time: 300, url: "https://s.magsrv.com/v1/vast.php?idzone=5829940" },
            { time: 720, url: "https://s.magsrv.com/v1/vast.php?idzone=5829940" },
            { time: 1620, url: "https://s.magsrv.com/v1/vast.php?idzone=5829940" },
            { time: 2700, url: "https://s.magsrv.com/v1/vast.php?idzone=5829940" }
        ];
        const POST_ROLL_AD_URL = "https://s.magsrv.com/v1/vast.php?idzone=5829940";
        
        // ============================
        // PLATFORM STATE
        // ============================
        const platformState = {
            currentUser: null,
            isAuthenticated: false,
            currentView: 'home',
            videos: [], // Cache for videos
            loadingVideos: false,
            hasVideosLoaded: false,
            userLikes: new Set(), // Track liked videos for current user
            userDislikes: new Set(), // Track disliked videos for current user
            isDarkMode: localStorage.getItem('streamFlixDarkMode') === 'true',
            currentVideo: null,
            isUploading: false,
            selectedVideoFile: null,
            videoDuration: 0,
            thumbnailOption: 'auto', // 'auto' or 'custom'
            customThumbnailFile: null,
            generatedThumbnailUrl: null
        };
        
        // ============================
        // DOM ELEMENTS
        // ============================
        const elements = {
            // Header
            menuButton: document.getElementById('menuButton'),
            sidebar: document.getElementById('sidebar'),
            darkModeToggle: document.getElementById('darkModeToggle'),
            uploadButton: document.getElementById('uploadButton'),
            userAvatar: document.getElementById('userAvatar'),
            searchInput: document.getElementById('searchInput'),
            searchButton: document.getElementById('searchButton'),
            
            // Sidebar
            loginItem: document.getElementById('loginItem'),
            logoutItem: document.getElementById('logoutItem'),
            
            // Views
            viewContainer: document.getElementById('viewContainer'),
            homeView: document.getElementById('homeView'),
            videoDetailView: document.getElementById('videoDetailView'),
            authView: document.getElementById('authView'),
            uploadView: document.getElementById('uploadView'),
            
            // Video Grid
            loadingState: document.getElementById('loadingState'),
            videosGrid: document.getElementById('videosGrid'),
            
            // Authentication
            authForm: document.getElementById('authForm'),
            authEmail: document.getElementById('authEmail'),
            authPassword: document.getElementById('authPassword'),
            authSubmitButton: document.getElementById('authSubmitButton'),
            showSignup: document.getElementById('showSignup'),
            signupForm: document.getElementById('signupForm'),
            signupUsername: document.getElementById('signupUsername'),
            signupEmail: document.getElementById('signupEmail'),
            signupPassword: document.getElementById('signupPassword'),
            signupButton: document.getElementById('signupButton'),
            
            // Upload
            uploadArea: document.getElementById('uploadArea'),
            videoUpload: document.getElementById('videoUpload'),
            videoPreviewContainer: document.getElementById('videoPreviewContainer'),
            videoPreview: document.getElementById('videoPreview'),
            thumbnailOptionsContainer: document.getElementById('thumbnailOptionsContainer'),
            autoThumbnailOption: document.getElementById('autoThumbnailOption'),
            customThumbnailOption: document.getElementById('customThumbnailOption'),
            generateThumbnailBtn: document.getElementById('generateThumbnailBtn'),
            thumbnailUploadArea: document.getElementById('thumbnailUploadArea'),
            thumbnailUpload: document.getElementById('thumbnailUpload'),
            thumbnailPreview: document.getElementById('thumbnailPreview'),
            videoInfoContainer: document.getElementById('videoInfoContainer'),
            videoDescContainer: document.getElementById('videoDescContainer'),
            videoTitle: document.getElementById('videoTitle'),
            videoDescription: document.getElementById('videoDescription'),
            submitUpload: document.getElementById('submitUpload'),
            uploadProgressContainer: document.getElementById('uploadProgressContainer'),
            uploadProgressBar: document.getElementById('uploadProgressBar'),
            progressText: document.getElementById('progressText'),
            uploadSuccess: document.getElementById('uploadSuccess'),
            
            // Modal
            embedModal: document.getElementById('embedModal'),
            embedCode: document.getElementById('embedCode'),
            
            // Toast
            toast: document.getElementById('toast'),
            toastIcon: document.getElementById('toastIcon'),
            toastMessage: document.getElementById('toastMessage')
        };
        
        // ============================
        // INITIALIZATION
        // ============================
        async function initPlatform() {
            // Initialize Firebase
            initializeFirebase();
            
            // Set up event listeners
            setupEventListeners();
            
            // Load videos from Back4App
            loadVideos();
            
            // Apply dark mode if enabled
            if (platformState.isDarkMode) {
                enableDarkMode();
            }
        }
        
        // ============================
        // FIREBASE AUTHENTICATION
        // ============================
        function initializeFirebase() {
            try {
                const firebaseApp = firebase.initializeApp(firebaseConfig);
                const auth = firebase.auth();
                
                // Listen for auth state changes
                auth.onAuthStateChanged(async (user) => {
                    if (user) {
                        platformState.currentUser = {
                            uid: user.uid,
                            email: user.email,
                            displayName: user.displayName || user.email.split('@')[0]
                        };
                        platformState.isAuthenticated = true;
                        
                        // Load user's liked and disliked videos
                        await loadUserLikes(user.uid);
                        await loadUserDislikes(user.uid);
                        
                        // Update UI
                        updateAuthUI();
                        
                        showToast(`Welcome back, ${platformState.currentUser.displayName}!`, 'success');
                    } else {
                        platformState.currentUser = null;
                        platformState.isAuthenticated = false;
                        platformState.userLikes.clear();
                        platformState.userDislikes.clear();
                        updateAuthUI();
                    }
                });
                
                // Google Auth Provider
                window.googleAuthProvider = new firebase.auth.GoogleAuthProvider();
                googleAuthProvider.addScope('profile');
                googleAuthProvider.addScope('email');
                
            } catch (error) {
                console.error('Firebase initialization error:', error);
                showToast('Authentication service unavailable', 'error');
            }
        }
        
        // ============================
        // BACK4APP VIDEO MANAGEMENT
        // ============================
        async function loadVideos(searchQuery = '') {
            // Only show loading on initial load when no videos cached
            if (!platformState.hasVideosLoaded && !platformState.videos.length) {
                elements.loadingState.style.display = 'block';
                elements.videosGrid.innerHTML = '';
            }
            
            platformState.loadingVideos = true;
            
            try {
                const Video = Parse.Object.extend('Video');
                const query = new Parse.Query(Video);
                
                // Filter by search query if provided
                if (searchQuery) {
                    query.matches('title', searchQuery, 'i');
                }
                
                // Sort by creation date (newest first)
                query.descending('createdAt');
                
                // Limit to 50 videos
                query.limit(50);
                
                const results = await query.find();
                
                // Clear existing videos
                platformState.videos = [];
                
                // Process results
                results.forEach((videoObj) => {
                    const video = {
                        id: videoObj.id,
                        title: videoObj.get('title') || 'Untitled Video',
                        description: videoObj.get('description') || '',
                        videoUrl: videoObj.get('videoUrl'),
                        thumbnailUrl: videoObj.get('thumbnailUrl'),
                        creatorId: videoObj.get('creatorId'),
                        creatorName: videoObj.get('creatorName') || 'Unknown Creator',
                        views: videoObj.get('views') || 0,
                        likes: videoObj.get('likes') || 0,
                        dislikes: videoObj.get('dislikes') || 0,
                        commentsCount: videoObj.get('commentsCount') || 0,
                        createdAt: videoObj.get('createdAt'),
                        duration: videoObj.get('duration') || '0:00'
                    };
                    
                    platformState.videos.push(video);
                });
                
                // Hide loading state
                elements.loadingState.style.display = 'none';
                platformState.loadingVideos = false;
                platformState.hasVideosLoaded = true;
                
                // Display videos
                displayVideos();
                
            } catch (error) {
                console.error('Error loading videos:', error);
                elements.loadingState.style.display = 'none';
                platformState.loadingVideos = false;
                
                // Only show error if we have no videos at all
                if (!platformState.videos.length) {
                    showToast('Error loading videos', 'error');
                }
            }
        }
        
        function displayVideos() {
            // Clear grid
            elements.videosGrid.innerHTML = '';
            
            // If no videos, show empty container (no messages)
            if (platformState.videos.length === 0) {
                return;
            }
            
            // Create video cards
            platformState.videos.forEach(video => {
                const videoCard = createVideoCard(video);
                elements.videosGrid.appendChild(videoCard);
            });
        }
        
        function createVideoCard(video) {
            const card = document.createElement('div');
            card.className = 'video-card';
            card.dataset.videoId = video.id;
            
            // Format view count
            const viewCount = formatNumber(video.views);
            
            // Format date
            const uploadDate = formatDate(video.createdAt);
            
            card.innerHTML = `
                <div class="video-thumbnail" style="background-image: url('${video.thumbnailUrl || 'https://via.placeholder.com/280x160?text=No+Thumbnail'}'); background-size: cover; background-position: center;">
                    <i class="fas fa-play-circle" style="font-size: 48px; color: rgba(255, 255, 255, 0.9); position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);"></i>
                    ${video.duration ? `<span style="position: absolute; bottom: 8px; right: 8px; background: rgba(0, 0, 0, 0.8); color: white; padding: 2px 6px; border-radius: 4px; font-size: 12px;">${video.duration}</span>` : ''}
                </div>
                <div class="video-info">
                    <h3 class="video-title">${video.title}</h3>
                    <p class="video-creator">${video.creatorName}</p>
                    <div class="video-stats">
                        <span>${viewCount} views</span>
                        <span></span>
                        <span>${uploadDate}</span>
                    </div>
                </div>
            `;
            
            card.addEventListener('click', () => {
                showVideoDetail(video);
            });
            
            return card;
        }
        
        async function saveVideoToBack4App(videoData) {
            try {
                const Video = Parse.Object.extend('Video');
                const video = new Video();
                
                // Set video properties
                video.set('title', videoData.title);
                video.set('description', videoData.description);
                video.set('videoUrl', videoData.videoUrl);
                video.set('thumbnailUrl', videoData.thumbnailUrl);
                video.set('creatorId', platformState.currentUser.uid);
                video.set('creatorName', platformState.currentUser.displayName);
                video.set('views', 0);
                video.set('likes', 0);
                video.set('dislikes', 0);
                video.set('commentsCount', 0);
                video.set('duration', videoData.duration || '0:00');
                
                await video.save();
                
                // Add to local cache
                const newVideo = {
                    id: video.id,
                    ...videoData,
                    creatorId: platformState.currentUser.uid,
                    creatorName: platformState.currentUser.displayName,
                    views: 0,
                    likes: 0,
                    dislikes: 0,
                    commentsCount: 0,
                    createdAt: new Date()
                };
                
                platformState.videos.unshift(newVideo);
                displayVideos();
                
                return video.id;
                
            } catch (error) {
                console.error('Error saving video to Back4App:', error);
                throw error;
            }
        }
        
        async function updateVideoLikes(videoId, increment = true) {
            try {
                const Video = Parse.Object.extend('Video');
                const query = new Parse.Query(Video);
                const video = await query.get(videoId);
                
                const currentLikes = video.get('likes') || 0;
                video.set('likes', increment ? currentLikes + 1 : Math.max(0, currentLikes - 1));
                
                await video.save();
                
                // Update local cache
                const videoIndex = platformState.videos.findIndex(v => v.id === videoId);
                if (videoIndex !== -1) {
                    if (increment) {
                        platformState.videos[videoIndex].likes++;
                    } else {
                        platformState.videos[videoIndex].likes = Math.max(0, platformState.videos[videoIndex].likes - 1);
                    }
                }
                
            } catch (error) {
                console.error('Error updating video likes:', error);
                throw error;
            }
        }
        
        async function updateVideoDislikes(videoId, increment = true) {
            try {
                const Video = Parse.Object.extend('Video');
                const query = new Parse.Query(Video);
                const video = await query.get(videoId);
                
                const currentDislikes = video.get('dislikes') || 0;
                video.set('dislikes', increment ? currentDislikes + 1 : Math.max(0, currentDislikes - 1));
                
                await video.save();
                
                // Update local cache
                const videoIndex = platformState.videos.findIndex(v => v.id === videoId);
                if (videoIndex !== -1) {
                    if (increment) {
                        platformState.videos[videoIndex].dislikes++;
                    } else {
                        platformState.videos[videoIndex].dislikes = Math.max(0, platformState.videos[videoIndex].dislikes - 1);
                    }
                }
                
            } catch (error) {
                console.error('Error updating video dislikes:', error);
                throw error;
            }
        }
        
        async function incrementViewCount(videoId) {
            try {
                const Video = Parse.Object.extend('Video');
                const query = new Parse.Query(Video);
                const video = await query.get(videoId);
                
                const currentViews = video.get('views') || 0;
                video.set('views', currentViews + 1);
                
                await video.save();
                
                // Update local cache
                const videoIndex = platformState.videos.findIndex(v => v.id === videoId);
                if (videoIndex !== -1) {
                    platformState.videos[videoIndex].views++;
                }
                
            } catch (error) {
                console.error('Error incrementing view count:', error);
            }
        }
        
        // ============================
        // USER LIKES & DISLIKES MANAGEMENT
        // ============================
        async function loadUserLikes(userId) {
            try {
                const UserLike = Parse.Object.extend('UserLike');
                const query = new Parse.Query(UserLike);
                query.equalTo('userId', userId);
                
                const results = await query.find();
                
                platformState.userLikes.clear();
                results.forEach(like => {
                    platformState.userLikes.add(like.get('videoId'));
                });
                
            } catch (error) {
                console.error('Error loading user likes:', error);
            }
        }
        
        async function loadUserDislikes(userId) {
            try {
                const UserDislike = Parse.Object.extend('UserDislike');
                const query = new Parse.Query(UserDislike);
                query.equalTo('userId', userId);
                
                const results = await query.find();
                
                platformState.userDislikes.clear();
                results.forEach(dislike => {
                    platformState.userDislikes.add(dislike.get('videoId'));
                });
                
            } catch (error) {
                console.error('Error loading user dislikes:', error);
            }
        }
        
        async function toggleLike(videoId) {
            if (!platformState.isAuthenticated) {
                showToast('Please login to like videos', 'error');
                switchView('auth');
                return;
            }
            
            try {
                const UserLike = Parse.Object.extend('UserLike');
                const UserDislike = Parse.Object.extend('UserDislike');
                
                // Check if already disliked
                if (platformState.userDislikes.has(videoId)) {
                    // Remove dislike first
                    const dislikeQuery = new Parse.Query(UserDislike);
                    dislikeQuery.equalTo('userId', platformState.currentUser.uid);
                    dislikeQuery.equalTo('videoId', videoId);
                    const existingDislike = await dislikeQuery.first();
                    
                    if (existingDislike) {
                        await existingDislike.destroy();
                        platformState.userDislikes.delete(videoId);
                        await updateVideoDislikes(videoId, false);
                    }
                }
                
                // Check if already liked
                const likeQuery = new Parse.Query(UserLike);
                likeQuery.equalTo('userId', platformState.currentUser.uid);
                likeQuery.equalTo('videoId', videoId);
                const existingLike = await likeQuery.first();
                
                if (existingLike) {
                    // Unlike
                    await existingLike.destroy();
                    platformState.userLikes.delete(videoId);
                    await updateVideoLikes(videoId, false);
                    showToast('Removed like', 'info');
                } else {
                    // Like
                    const like = new UserLike();
                    like.set('userId', platformState.currentUser.uid);
                    like.set('videoId', videoId);
                    await like.save();
                    
                    platformState.userLikes.add(videoId);
                    await updateVideoLikes(videoId, true);
                    showToast('Liked!', 'success');
                }
                
                // Update UI if on video detail page
                if (platformState.currentVideo && platformState.currentVideo.id === videoId) {
                    updateLikeDislikeButtons(videoId);
                }
                
            } catch (error) {
                console.error('Error toggling like:', error);
                showToast('Error updating like', 'error');
            }
        }
        
        async function toggleDislike(videoId) {
            if (!platformState.isAuthenticated) {
                showToast('Please login to dislike videos', 'error');
                switchView('auth');
                return;
            }
            
            try {
                const UserLike = Parse.Object.extend('UserLike');
                const UserDislike = Parse.Object.extend('UserDislike');
                
                // Check if already liked
                if (platformState.userLikes.has(videoId)) {
                    // Remove like first
                    const likeQuery = new Parse.Query(UserLike);
                    likeQuery.equalTo('userId', platformState.currentUser.uid);
                    likeQuery.equalTo('videoId', videoId);
                    const existingLike = await likeQuery.first();
                    
                    if (existingLike) {
                        await existingLike.destroy();
                        platformState.userLikes.delete(videoId);
                        await updateVideoLikes(videoId, false);
                    }
                }
                
                // Check if already disliked
                const dislikeQuery = new Parse.Query(UserDislike);
                dislikeQuery.equalTo('userId', platformState.currentUser.uid);
                dislikeQuery.equalTo('videoId', videoId);
                const existingDislike = await dislikeQuery.first();
                
                if (existingDislike) {
                    // Remove dislike
                    await existingDislike.destroy();
                    platformState.userDislikes.delete(videoId);
                    await updateVideoDislikes(videoId, false);
                    showToast('Removed dislike', 'info');
                } else {
                    // Dislike
                    const dislike = new UserDislike();
                    dislike.set('userId', platformState.currentUser.uid);
                    dislike.set('videoId', videoId);
                    await dislike.save();
                    
                    platformState.userDislikes.add(videoId);
                    await updateVideoDislikes(videoId, true);
                    showToast('Disliked', 'info');
                }
                
                // Update UI if on video detail page
                if (platformState.currentVideo && platformState.currentVideo.id === videoId) {
                    updateLikeDislikeButtons(videoId);
                }
                
            } catch (error) {
                console.error('Error toggling dislike:', error);
                showToast('Error updating dislike', 'error');
            }
        }
        
        // ============================
        // VIDEO DETAIL VIEW
        // ============================
        async function showVideoDetail(video) {
            platformState.currentVideo = video;
            
            // Increment view count
            await incrementViewCount(video.id);
            
            // Create video detail HTML
            const videoDetailHTML = `
                <div class="video-detail-container">
                    <div class="video-player-container" id="videoPlayerContainer">
                        <!-- Fluid Player will be initialized here -->
                    </div>
                    
                    <div class="video-info-detail">
                        <h1 class="video-title-detail">${video.title}</h1>
                        <div class="video-meta">
                            <span>${formatNumber(video.views + 1)} views</span>
                            <span></span>
                            <span>${formatDate(video.createdAt)}</span>
                        </div>
                        
                        <div class="video-actions">
                            <button class="action-button ${platformState.userLikes.has(video.id) ? 'active like' : ''}" 
                                    onclick="toggleLike('${video.id}')" id="likeButton">
                                <i class="fas fa-thumbs-up"></i>
                                <span id="likeCount">${formatNumber(video.likes)}</span>
                            </button>
                            <button class="action-button ${platformState.userDislikes.has(video.id) ? 'active dislike' : ''}" 
                                    onclick="toggleDislike('${video.id}')" id="dislikeButton">
                                <i class="fas fa-thumbs-down"></i>
                                <span id="dislikeCount">${formatNumber(video.dislikes)}</span>
                            </button>
                            <button class="action-button" onclick="shareVideo('${video.id}')">
                                <i class="fas fa-share"></i>
                                <span>Share</span>
                            </button>
                            <div class="quality-selector">
                                <button class="action-button" id="qualityButton">
                                    <i class="fas fa-download"></i>
                                    <span>Download</span>
                                </button>
                                <div class="quality-dropdown" id="qualityDropdown">
                                    <a href="${video.videoUrl}" class="quality-option" download="${video.title.replace(/[^a-z0-9]/gi, '_')}_360p.mp4">360p</a>
                                    <a href="${video.videoUrl}" class="quality-option" download="${video.title.replace(/[^a-z0-9]/gi, '_')}_720p.mp4">720p</a>
                                    <a href="${video.videoUrl}" class="quality-option" download="${video.title.replace(/[^a-z0-9]/gi, '_')}_1080p.mp4">1080p</a>
                                </div>
                            </div>
                            <button class="action-button" onclick="showEmbedCode('${video.id}')">
                                <i class="fas fa-code"></i>
                                <span>Embed</span>
                            </button>
                        </div>
                        
                        <div class="creator-info-detail">
                            <div class="creator-avatar-small">${video.creatorName.charAt(0).toUpperCase()}</div>
                            <div class="creator-details">
                                <h3>${video.creatorName}</h3>
                                <p>${formatNumber(video.views + 1)} subscribers</p>
                            </div>
                            <button class="subscribe-button">Subscribe</button>
                        </div>
                        
                        <div class="video-description">
                            <p>${video.description || 'No description provided.'}</p>
                        </div>
                    </div>
                    
                    <!-- Comments Section -->
                    <div class="comments-section">
                        <h3>Comments (${video.commentsCount || 0})</h3>
                        ${platformState.isAuthenticated ? `
                            <div class="comment-input">
                                <div class="user-avatar-small">${platformState.currentUser.displayName.charAt(0).toUpperCase()}</div>
                                <input type="text" placeholder="Add a comment..." id="commentInput">
                                <button class="comment-button" onclick="addComment('${video.id}')">Comment</button>
                            </div>
                        ` : `
                            <p>Please <a href="#" onclick="switchView('auth')">sign in</a> to comment.</p>
                        `}
                        <div id="commentsList">
                            <!-- Comments will be loaded here -->
                        </div>
                    </div>
                    
                    <!-- Related Videos -->
                    <div class="related-videos">
                        <h3>Recommended Videos</h3>
                        <div id="relatedVideos">
                            <!-- Related videos will be loaded here -->
                        </div>
                    </div>
                </div>
            `;
            
            // Update view
            switchView('videoDetail');
            elements.videoDetailView.innerHTML = videoDetailHTML;
            
            // Initialize Fluid Player with VAST ads
            initializeVideoPlayer(video);
            
            // Setup download quality selector
            setupQualitySelector();
            
            // Load comments
            loadComments(video.id);
            
            // Load related videos
            loadRelatedVideos(video.id);
        }
        
        function updateLikeDislikeButtons(videoId) {
            const likeButton = document.getElementById('likeButton');
            const dislikeButton = document.getElementById('dislikeButton');
            const likeCount = document.getElementById('likeCount');
            const dislikeCount = document.getElementById('dislikeCount');
            const video = platformState.videos.find(v => v.id === videoId);
            
            if (likeButton && video) {
                if (platformState.userLikes.has(videoId)) {
                    likeButton.classList.add('active', 'like');
                    dislikeButton.classList.remove('active', 'dislike');
                } else if (platformState.userDislikes.has(videoId)) {
                    dislikeButton.classList.add('active', 'dislike');
                    likeButton.classList.remove('active', 'like');
                } else {
                    likeButton.classList.remove('active', 'like');
                    dislikeButton.classList.remove('active', 'dislike');
                }
                
                likeCount.textContent = formatNumber(video.likes);
                dislikeCount.textContent = formatNumber(video.dislikes);
            }
        }
        
        function setupQualitySelector() {
            const qualityButton = document.getElementById('qualityButton');
            const qualityDropdown = document.getElementById('qualityDropdown');
            
            if (qualityButton && qualityDropdown) {
                qualityButton.addEventListener('click', (e) => {
                    e.stopPropagation();
                    qualityDropdown.classList.toggle('show');
                });
                
                // Close dropdown when clicking outside
                document.addEventListener('click', () => {
                    qualityDropdown.classList.remove('show');
                });
                
                // Prevent dropdown from closing when clicking inside
                qualityDropdown.addEventListener('click', (e) => {
                    e.stopPropagation();
                });
            }
        }
        
        // ============================
        // FLUID VIDEO PLAYER WITH VAST ADS
        // ============================
        function initializeVideoPlayer(video) {
            const container = document.getElementById('videoPlayerContainer');
            container.innerHTML = '';
            
            // Create video element
            const videoElement = document.createElement('video');
            videoElement.id = 'fluid-player-' + video.id;
            videoElement.style.width = '100%';
            videoElement.style.height = '100%';
            videoElement.controls = true;
            
            const source = document.createElement('source');
            source.src = video.videoUrl;
            source.type = 'video/mp4';
            
            videoElement.appendChild(source);
            container.appendChild(videoElement);
            
            // Prepare ad list
            const adList = [
                {
                    roll: 'preRoll',
                    vastTag: PRE_ROLL_AD_URL,
                    adText: 'Advertisement - Skip in 5 seconds'
                }
            ];
            
            // Add mid-roll ads
            MID_ROLL_ADS.forEach((ad, index) => {
                adList.push({
                    roll: 'midRoll',
                    vastTag: ad.url,
                    timer: ad.time,
                    adText: `Advertisement ${index + 1} - Skip in 5 seconds`
                });
            });
            
            // Add post-roll ads
            adList.push({
                roll: 'postRoll',
                vastTag: POST_ROLL_AD_URL,
                adText: 'Advertisement - Skip in 5 seconds'
            });
            
            // Initialize Fluid Player with VAST ads
            const player = fluidPlayer(
                videoElement.id,
                {
                    layoutControls: {
                        primaryColor: "#ff0000",
                        posterImage: video.thumbnailUrl,
                        allowDownload: false,
                        playButtonShowing: true,
                        fillToContainer: true,
                        autoPlay: true,
                        mute: false,
                        keyboardControl: true,
                        playlist: false,
                        allowTheatre: true,
                        playbackRateEnabled: true,
                        logo: {
                            imageUrl: null,
                            position: 'top left',
                            clickUrl: null,
                            opacity: 1
                        }
                    },
                    vastOptions: {
                        adList: adList,
                        adCTAText: true,
                        adCTATextPosition: 'top right',
                        skipButtonCaption: 'Skip Ad [seconds]',
                        skipButtonClickCaption: 'Skip Ad',
                        adText: 'Advertisement',
                        adTextPosition: 'top left',
                        adClickable: true,
                        autoPlayAd: true
                    }
                }
            );
            
            // Handle ad errors gracefully
            player.on('adError', function() {
                console.log('Ad failed to load, continuing with video');
                player.play();
            });
            
            // Handle video errors
            videoElement.addEventListener('error', function(e) {
                console.error('Video error:', e);
                showToast('Error playing video', 'error');
            });
            
            return player;
        }
        
        // ============================
        // COMMENTS MANAGEMENT
        // ============================
        async function loadComments(videoId) {
            try {
                const Comment = Parse.Object.extend('Comment');
                const query = new Parse.Query(Comment);
                query.equalTo('videoId', videoId);
                query.descending('createdAt');
                query.limit(50);
                
                const results = await query.find();
                
                const commentsList = document.getElementById('commentsList');
                commentsList.innerHTML = '';
                
                if (results.length === 0) {
                    commentsList.innerHTML = '<p>No comments yet. Be the first to comment!</p>';
                    return;
                }
                
                results.forEach(comment => {
                    const commentElement = document.createElement('div');
                    commentElement.className = 'comment';
                    
                    const userName = comment.get('userName') || 'Anonymous';
                    const userInitial = userName.charAt(0).toUpperCase();
                    
                    commentElement.innerHTML = `
                        <div class="comment-avatar">${userInitial}</div>
                        <div class="comment-content">
                            <h4>${userName}</h4>
                            <p>${comment.get('text') || ''}</p>
                            <div class="comment-actions">
                                <span style="color: var(--light-text-secondary); font-size: 12px;">
                                    ${formatDate(comment.get('createdAt'))}
                                </span>
                            </div>
                        </div>
                    `;
                    
                    commentsList.appendChild(commentElement);
                });
                
            } catch (error) {
                console.error('Error loading comments:', error);
                document.getElementById('commentsList').innerHTML = '<p>Error loading comments</p>';
            }
        }
        
        async function addComment(videoId) {
            if (!platformState.isAuthenticated) {
                showToast('Please login to comment', 'error');
                return;
            }
            
            const commentInput = document.getElementById('commentInput');
            const text = commentInput.value.trim();
            
            if (!text) {
                showToast('Please enter a comment', 'error');
                return;
            }
            
            try {
                const Comment = Parse.Object.extend('Comment');
                const comment = new Comment();
                
                comment.set('videoId', videoId);
                comment.set('userId', platformState.currentUser.uid);
                comment.set('userName', platformState.currentUser.displayName);
                comment.set('text', text);
                
                await comment.save();
                
                // Update video comment count
                const Video = Parse.Object.extend('Video');
                const query = new Parse.Query(Video);
                const video = await query.get(videoId);
                
                const currentCount = video.get('commentsCount') || 0;
                video.set('commentsCount', currentCount + 1);
                await video.save();
                
                // Update local cache
                const videoIndex = platformState.videos.findIndex(v => v.id === videoId);
                if (videoIndex !== -1) {
                    platformState.videos[videoIndex].commentsCount = currentCount + 1;
                }
                
                // Clear input and reload comments
                commentInput.value = '';
                loadComments(videoId);
                
                showToast('Comment added!', 'success');
                
            } catch (error) {
                console.error('Error adding comment:', error);
                showToast('Error adding comment', 'error');
            }
        }
        
        // ============================
        // RELATED VIDEOS
        // ============================
        function loadRelatedVideos(currentVideoId) {
            const relatedVideosContainer = document.getElementById('relatedVideos');
            
            // Get up to 5 related videos (excluding current)
            const relatedVideos = platformState.videos
                .filter(v => v.id !== currentVideoId)
                .slice(0, 5);
            
            relatedVideosContainer.innerHTML = '';
            
            if (relatedVideos.length === 0) {
                relatedVideosContainer.innerHTML = '<p>No related videos found.</p>';
                return;
            }
            
            relatedVideos.forEach(video => {
                const card = document.createElement('div');
                card.className = 'related-video-card';
                card.innerHTML = `
                    <div class="related-thumbnail" style="background-image: url('${video.thumbnailUrl || 'https://via.placeholder.com/160x90?text=No+Thumbnail'}'); background-size: cover; background-position: center;">
                        <i class="fas fa-play-circle" style="font-size: 24px; color: rgba(255, 255, 255, 0.9); position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);"></i>
                        ${video.duration ? `<span style="position: absolute; bottom: 4px; right: 4px; background: rgba(0, 0, 0, 0.8); color: white; padding: 1px 4px; border-radius: 2px; font-size: 10px;">${video.duration}</span>` : ''}
                    </div>
                    <div class="related-info">
                        <h4>${video.title.length > 50 ? video.title.substring(0, 50) + '...' : video.title}</h4>
                        <p>${video.creatorName}</p>
                        <p>${formatNumber(video.views)} views  ${formatDate(video.createdAt)}</p>
                    </div>
                `;
                
                card.addEventListener('click', () => {
                    showVideoDetail(video);
                });
                
                relatedVideosContainer.appendChild(card);
            });
        }
        
        // ============================
        // EMBED CODE FUNCTIONALITY
        // ============================
        function showEmbedCode(videoId) {
            const video = platformState.videos.find(v => v.id === videoId);
            if (!video) return;
            
            const embedCode = `<iframe width="560" height="315" src="${window.location.origin}/embed.html?video=${videoId}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>`;
            
            elements.embedCode.value = embedCode;
            elements.embedModal.classList.add('show');
        }
        
        function closeEmbedModal() {
            elements.embedModal.classList.remove('show');
        }
        
        function copyEmbedCode() {
            elements.embedCode.select();
            elements.embedCode.setSelectionRange(0, 99999); // For mobile devices
            document.execCommand('copy');
            showToast('Embed code copied to clipboard!', 'success');
        }
        
        // ============================
        // VIDEO UPLOAD TO CLOUDINARY
        // ============================
        async function uploadVideo() {
            if (platformState.isUploading) {
                return; // Prevent multiple uploads
            }
            
            if (!platformState.isAuthenticated) {
                showToast('Please login to upload videos', 'error');
                switchView('auth');
                return;
            }
            
            // Get file ONLY from file input
            const videoFile = platformState.selectedVideoFile;
            const title = elements.videoTitle.value.trim();
            const description = elements.videoDescription.value.trim();
            
            // Validate
            if (!videoFile) {
                showToast('Please select a video file', 'error');
                return;
            }
            
            if (!title) {
                showToast('Please enter a video title', 'error');
                return;
            }
            
            // Validate file size (2GB max)
            if (videoFile.size > 2 * 1024 * 1024 * 1024) {
                showToast('Video too large. Maximum size is 2GB', 'error');
                return;
            }
            
            // Set uploading state
            platformState.isUploading = true;
            
            // Show progress
            elements.uploadProgressContainer.style.display = 'block';
            elements.uploadProgressBar.style.width = '0%';
            elements.progressText.textContent = '0% uploaded';
            elements.submitUpload.disabled = true;
            elements.submitUpload.textContent = 'Uploading...';
            
            try {
                // Create FormData for video upload
                const videoFormData = new FormData();
                videoFormData.append('file', videoFile);
                videoFormData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);
                videoFormData.append('cloud_name', CLOUDINARY_CLOUD_NAME);
                videoFormData.append('resource_type', 'video');
                
                // Use fetch with progress tracking
                const xhr = new XMLHttpRequest();
                
                xhr.upload.addEventListener('progress', function(e) {
                    if (e.lengthComputable) {
                        const percentComplete = Math.round((e.loaded / e.total) * 100);
                        elements.uploadProgressBar.style.width = percentComplete + '%';
                        elements.progressText.textContent = percentComplete + '% uploaded';
                    }
                });
                
                xhr.addEventListener('load', async function() {
                    if (xhr.status === 200) {
                        const cloudinaryData = JSON.parse(xhr.responseText);
                        
                        // Get secure_url from Cloudinary response
                        const videoUrl = cloudinaryData.secure_url;
                        
                        // Get thumbnail URL
                        let thumbnailUrl;
                        if (platformState.thumbnailOption === 'auto' && platformState.generatedThumbnailUrl) {
                            // Use generated thumbnail
                            thumbnailUrl = platformState.generatedThumbnailUrl;
                        } else if (platformState.thumbnailOption === 'custom' && platformState.customThumbnailFile) {
                            // Upload custom thumbnail
                            thumbnailUrl = await uploadThumbnailToCloudinary(platformState.customThumbnailFile);
                        } else {
                            // Fallback: Generate thumbnail from video
                            thumbnailUrl = `https://res.cloudinary.com/${CLOUDINARY_CLOUD_NAME}/video/upload/so_1/${cloudinaryData.public_id}.jpg`;
                        }
                        
                        // Format duration
                        const duration = formatDuration(cloudinaryData.duration || platformState.videoDuration);
                        
                        // Save to Back4App with metadata
                        const videoData = {
                            title: title,
                            description: description,
                            videoUrl: videoUrl,
                            thumbnailUrl: thumbnailUrl,
                            duration: duration
                        };
                        
                        await saveVideoToBack4App(videoData);
                        
                        // Show success
                        elements.uploadProgressContainer.style.display = 'none';
                        elements.uploadSuccess.style.display = 'block';
                        elements.submitUpload.style.display = 'none';
                        
                        // Reset form
                        resetUploadForm();
                        
                        platformState.isUploading = false;
                        
                        showToast('Video uploaded successfully!', 'success');
                    } else {
                        throw new Error('Upload failed with status: ' + xhr.status);
                    }
                });
                
                xhr.addEventListener('error', function() {
                    throw new Error('Network error during upload');
                });
                
                xhr.open('POST', `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/video/upload`);
                xhr.send(videoFormData);
                
            } catch (error) {
                console.error('Upload error:', error);
                elements.uploadProgressContainer.style.display = 'none';
                elements.submitUpload.disabled = false;
                elements.submitUpload.textContent = 'Upload Video';
                platformState.isUploading = false;
                showToast('Upload failed: ' + error.message, 'error');
            }
        }
        
        async function uploadThumbnailToCloudinary(thumbnailFile) {
            try {
                const formData = new FormData();
                formData.append('file', thumbnailFile);
                formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);
                formData.append('cloud_name', CLOUDINARY_CLOUD_NAME);
                
                const response = await fetch(`https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/image/upload`, {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    throw new Error('Thumbnail upload failed');
                }
                
                const data = await response.json();
                return data.secure_url;
                
            } catch (error) {
                console.error('Thumbnail upload error:', error);
                // Fallback to a default thumbnail
                return `https://via.placeholder.com/1280x720/FF0000/FFFFFF?text=${encodeURIComponent('StreamFlix')}`;
            }
        }
        
        function generateThumbnailFromVideo() {
            if (!platformState.selectedVideoFile) {
                showToast('Please select a video first', 'error');
                return;
            }
            
            const video = elements.videoPreview;
            const canvas = document.createElement('canvas');
            canvas.width = 640;
            canvas.height = 360;
            const ctx = canvas.getContext('2d');
            
            // Draw video frame at 1 second
            video.currentTime = 1;
            
            video.addEventListener('seeked', function() {
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                
                // Convert canvas to blob
                canvas.toBlob(function(blob) {
                    const thumbnailFile = new File([blob], 'thumbnail.jpg', { type: 'image/jpeg' });
                    platformState.customThumbnailFile = thumbnailFile;
                    
                    // Show preview
                    const thumbnailPreview = document.getElementById('thumbnailPreview');
                    thumbnailPreview.src = URL.createObjectURL(blob);
                    thumbnailPreview.style.display = 'block';
                    
                    // Save generated thumbnail URL for later use
                    platformState.generatedThumbnailUrl = thumbnailPreview.src;
                    
                    showToast('Thumbnail generated successfully!', 'success');
                }, 'image/jpeg', 0.8);
            });
        }
        
        function resetUploadForm() {
            platformState.selectedVideoFile = null;
            platformState.videoDuration = 0;
            platformState.thumbnailOption = 'auto';
            platformState.customThumbnailFile = null;
            platformState.generatedThumbnailUrl = null;
            
            elements.videoUpload.value = '';
            elements.videoPreviewContainer.style.display = 'none';
            elements.thumbnailOptionsContainer.style.display = 'none';
            elements.videoInfoContainer.style.display = 'none';
            elements.videoDescContainer.style.display = 'none';
            elements.videoTitle.value = '';
            elements.videoDescription.value = '';
            elements.thumbnailPreview.style.display = 'none';
            elements.thumbnailPreview.src = '';
            elements.thumbnailUpload.value = '';
            
            // Reset thumbnail option UI
            elements.autoThumbnailOption.classList.add('active');
            elements.customThumbnailOption.classList.remove('active');
            
            // Hide submit button
            elements.submitUpload.style.display = 'none';
            elements.submitUpload.disabled = false;
            elements.submitUpload.textContent = 'Upload Video';
        }
        
        // ============================
        // AUTHENTICATION UI
        // ============================
        function updateAuthUI() {
            if (platformState.isAuthenticated) {
                // Update user avatar
                elements.userAvatar.textContent = platformState.currentUser.displayName.charAt(0).toUpperCase();
                
                // Show upload button
                elements.uploadButton.style.display = 'block';
                
                // Update sidebar
                elements.loginItem.style.display = 'none';
                elements.logoutItem.style.display = 'flex';
            } else {
                elements.userAvatar.textContent = '?';
                elements.uploadButton.style.display = 'none';
                elements.loginItem.style.display = 'flex';
                elements.logoutItem.style.display = 'none';
            }
        }
        
        async function handleLogin(email, password) {
            try {
                await firebase.auth().signInWithEmailAndPassword(email, password);
                showToast('Successfully signed in!', 'success');
                switchView('home');
            } catch (error) {
                console.error('Login error:', error);
                showToast('Login failed: ' + error.message, 'error');
            }
        }
        
        async function handleSignup(username, email, password) {
            try {
                // Validate
                if (!username || username.length < 3) {
                    showToast('Username must be at least 3 characters', 'error');
                    return;
                }
                
                if (password.length < 6) {
                    showToast('Password must be at least 6 characters', 'error');
                    return;
                }
                
                // Create user with email/password
                const userCredential = await firebase.auth().createUserWithEmailAndPassword(email, password);
                
                // Update profile with username
                await userCredential.user.updateProfile({
                    displayName: username
                });
                
                showToast('Account created successfully!', 'success');
                switchView('home');
            } catch (error) {
                console.error('Signup error:', error);
                showToast('Signup failed: ' + error.message, 'error');
            }
        }
        
        async function handleGoogleLogin() {
            try {
                await firebase.auth().signInWithPopup(googleAuthProvider);
                showToast('Successfully signed in with Google!', 'success');
                switchView('home');
            } catch (error) {
                console.error('Google login error:', error);
                showToast('Google login failed: ' + error.message, 'error');
            }
        }
        
        async function logout() {
            try {
                await firebase.auth().signOut();
                showToast('Successfully logged out', 'info');
                switchView('home');
            } catch (error) {
                console.error('Logout error:', error);
                showToast('Logout failed: ' + error.message, 'error');
            }
        }
        
        // ============================
        // VIEW MANAGEMENT
        // ============================
        function switchView(viewName) {
            // Hide all views
            document.querySelectorAll('.view').forEach(view => {
                view.classList.add('hidden');
            });
            
            // Show requested view
            platformState.currentView = viewName;
            
            switch(viewName) {
                case 'home':
                    elements.homeView.classList.remove('hidden');
                    break;
                case 'videoDetail':
                    elements.videoDetailView.classList.remove('hidden');
                    break;
                case 'auth':
                    elements.authView.classList.remove('hidden');
                    break;
                case 'upload':
                    if (platformState.isAuthenticated) {
                        elements.uploadView.classList.remove('hidden');
                        // Reset upload form
                        resetUploadForm();
                        elements.uploadSuccess.style.display = 'none';
                        elements.submitUpload.style.display = 'none';
                        elements.submitUpload.disabled = false;
                        elements.submitUpload.textContent = 'Upload Video';
                        elements.uploadProgressContainer.style.display = 'none';
                        platformState.isUploading = false;
                    } else {
                        switchView('auth');
                    }
                    break;
            }
            
            // Close sidebar on mobile
            if (window.innerWidth <= 768) {
                elements.sidebar.classList.remove('active');
            }
        }
        
        // ============================
        // EVENT LISTENERS SETUP
        // ============================
        function setupEventListeners() {
            // Mobile menu
            elements.menuButton.addEventListener('click', () => {
                elements.sidebar.classList.toggle('active');
            });
            
            // Dark mode toggle
            elements.darkModeToggle.addEventListener('click', toggleDarkMode);
            
            // Search
            elements.searchButton.addEventListener('click', handleSearch);
            elements.searchInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') handleSearch();
            });
            
            // Sidebar navigation
            document.querySelectorAll('.sidebar-item').forEach(item => {
                item.addEventListener('click', () => {
                    // Remove active class from all items
                    document.querySelectorAll('.sidebar-item').forEach(i => {
                        i.classList.remove('active');
                    });
                    
                    // Add active class to clicked item
                    item.classList.add('active');
                    
                    const view = item.dataset.view;
                    if (view) {
                        switchView(view);
                    } else if (item.id === 'loginItem') {
                        switchView('auth');
                    } else if (item.id === 'logoutItem') {
                        logout();
                    }
                    
                    // Close sidebar on mobile
                    if (window.innerWidth <= 768) {
                        elements.sidebar.classList.remove('active');
                    }
                });
            });
            
            // Upload button
            elements.uploadButton.addEventListener('click', () => {
                switchView('upload');
            });
            
            // User avatar
            elements.userAvatar.addEventListener('click', () => {
                if (platformState.isAuthenticated) {
                    // Could show user menu
                } else {
                    switchView('auth');
                }
            });
            
            // Authentication
            elements.authForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const email = elements.authEmail.value;
                const password = elements.authPassword.value;
                handleLogin(email, password);
            });
            
            elements.showSignup.addEventListener('click', () => {
                elements.authForm.classList.add('hidden');
                elements.signupForm.classList.remove('hidden');
            });
            
            elements.signupButton.addEventListener('click', () => {
                const username = elements.signupUsername.value;
                const email = elements.signupEmail.value;
                const password = elements.signupPassword.value;
                handleSignup(username, email, password);
            });
            
            // Video upload area click
            elements.uploadArea.addEventListener('click', () => {
                elements.videoUpload.click();
            });
            
            // Video upload change
            elements.videoUpload.addEventListener('change', handleVideoSelect);
            
            // Thumbnail options
            elements.autoThumbnailOption.addEventListener('click', () => {
                elements.autoThumbnailOption.classList.add('active');
                elements.customThumbnailOption.classList.remove('active');
                platformState.thumbnailOption = 'auto';
            });
            
            elements.customThumbnailOption.addEventListener('click', () => {
                elements.customThumbnailOption.classList.add('active');
                elements.autoThumbnailOption.classList.remove('active');
                platformState.thumbnailOption = 'custom';
            });
            
            // Generate thumbnail button
            elements.generateThumbnailBtn.addEventListener('click', generateThumbnailFromVideo);
            
            // Custom thumbnail upload
            elements.thumbnailUploadArea.addEventListener('click', () => elements.thumbnailUpload.click());
            elements.thumbnailUpload.addEventListener('change', handleThumbnailSelect);
            
            // Drag and drop for video upload
            elements.uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                elements.uploadArea.classList.add('drag-over');
            });
            
            elements.uploadArea.addEventListener('dragleave', () => {
                elements.uploadArea.classList.remove('drag-over');
            });
            
            elements.uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                elements.uploadArea.classList.remove('drag-over');
                
                if (e.dataTransfer.files.length) {
                    const file = e.dataTransfer.files[0];
                    if (file.type.startsWith('video/')) {
                        elements.videoUpload.files = e.dataTransfer.files;
                        handleVideoSelect();
                    } else {
                        showToast('Please drop a video file', 'error');
                    }
                }
            });
            
            // Upload button click
            elements.submitUpload.addEventListener('click', (e) => {
                e.preventDefault();
                uploadVideo();
            });
            
            // Close modal when clicking outside
            elements.embedModal.addEventListener('click', (e) => {
                if (e.target === elements.embedModal) {
                    closeEmbedModal();
                }
            });
        }
        
        function handleVideoSelect() {
            const file = elements.videoUpload.files[0];
            if (file) {
                platformState.selectedVideoFile = file;
                
                // Show video preview
                const videoURL = URL.createObjectURL(file);
                elements.videoPreview.src = videoURL;
                elements.videoPreviewContainer.style.display = 'block';
                
                // Get video duration
                elements.videoPreview.addEventListener('loadedmetadata', function() {
                    platformState.videoDuration = this.duration;
                });
                
                // Show thumbnail options
                elements.thumbnailOptionsContainer.style.display = 'block';
                
                // Pre-fill title with filename (without extension) if empty
                if (!elements.videoTitle.value.trim()) {
                    const fileName = file.name.replace(/\.[^/.]+$/, ""); // Remove extension
                    elements.videoTitle.value = fileName;
                }
                
                // Show video info and description fields
                elements.videoInfoContainer.style.display = 'block';
                elements.videoDescContainer.style.display = 'block';
                
                // Show submit button
                elements.submitUpload.style.display = 'block';
                
                showToast(`Video selected: ${file.name}`, 'info');
            }
        }
        
        function handleThumbnailSelect() {
            const file = elements.thumbnailUpload.files[0];
            if (file) {
                if (!file.type.startsWith('image/')) {
                    showToast('Please select an image file', 'error');
                    return;
                }
                
                if (file.size > 5 * 1024 * 1024) {
                    showToast('Thumbnail too large. Maximum size is 5MB', 'error');
                    return;
                }
                
                platformState.customThumbnailFile = file;
                
                // Show preview
                const thumbnailURL = URL.createObjectURL(file);
                elements.thumbnailPreview.src = thumbnailURL;
                elements.thumbnailPreview.style.display = 'block';
                
                showToast('Thumbnail selected', 'info');
            }
        }
        
        function handleSearch() {
            const query = elements.searchInput.value.trim();
            if (query) {
                loadVideos(query);
                showToast(`Searching for "${query}"...`, 'info');
            } else {
                loadVideos(); // Reload all videos
            }
        }
        
        // ============================
        // UTILITY FUNCTIONS
        // ============================
        function formatNumber(num) {
            if (!num) return '0';
            if (num >= 1000000) {
                return (num / 1000000).toFixed(1) + 'M';
            } else if (num >= 1000) {
                return (num / 1000).toFixed(1) + 'K';
            }
            return num.toString();
        }
        
        function formatDate(dateString) {
            if (!dateString) return 'Recently';
            
            try {
                const date = new Date(dateString);
                const now = new Date();
                const diffMs = now - date;
                const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
                
                if (diffDays === 0) return 'Today';
                if (diffDays === 1) return 'Yesterday';
                if (diffDays < 7) return `${diffDays} days ago`;
                if (diffDays < 30) return `${Math.floor(diffDays / 7)} weeks ago`;
                if (diffDays < 365) return `${Math.floor(diffDays / 30)} months ago`;
                
                return `${Math.floor(diffDays / 365)} years ago`;
            } catch (e) {
                return 'Recently';
            }
        }
        
        function formatDuration(seconds) {
            if (!seconds) return '0:00';
            
            const hours = Math.floor(seconds / 3600);
            const mins = Math.floor((seconds % 3600) / 60);
            const secs = Math.floor(seconds % 60);
            
            if (hours > 0) {
                return `${hours}:${mins < 10 ? '0' : ''}${mins}:${secs < 10 ? '0' : ''}${secs}`;
            } else {
                return `${mins}:${secs < 10 ? '0' : ''}${secs}`;
            }
        }
        
        function toggleDarkMode() {
            if (platformState.isDarkMode) {
                document.body.classList.remove('dark-mode');
                platformState.isDarkMode = false;
                localStorage.setItem('streamFlixDarkMode', 'false');
                elements.darkModeToggle.innerHTML = '<i class="fas fa-moon"></i>';
            } else {
                document.body.classList.add('dark-mode');
                platformState.isDarkMode = true;
                localStorage.setItem('streamFlixDarkMode', 'true');
                elements.darkModeToggle.innerHTML = '<i class="fas fa-sun"></i>';
            }
        }
        
        function enableDarkMode() {
            document.body.classList.add('dark-mode');
            elements.darkModeToggle.innerHTML = '<i class="fas fa-sun"></i>';
        }
        
        function shareVideo(videoId) {
            const video = platformState.videos.find(v => v.id === videoId);
            if (video) {
                const shareUrl = window.location.origin + window.location.pathname + '?video=' + videoId;
                const shareText = `Watch "${video.title}" on Stream Flix`;
                
                if (navigator.share) {
                    navigator.share({
                        title: video.title,
                        text: shareText,
                        url: shareUrl
                    });
                } else {
                    navigator.clipboard.writeText(shareUrl);
                    showToast('Link copied to clipboard!', 'success');
                }
            }
        }
        
        function showToast(message, type = 'info') {
            elements.toastMessage.textContent = message;
            elements.toast.className = `toast toast-${type}`;
            
            // Set icon based on type
            switch(type) {
                case 'success':
                    elements.toastIcon.className = 'fas fa-check-circle';
                    break;
                case 'error':
                    elements.toastIcon.className = 'fas fa-exclamation-circle';
                    break;
                default:
                    elements.toastIcon.className = 'fas fa-info-circle';
            }
            
            elements.toast.classList.remove('hidden');
            elements.toast.classList.add('show');
            
            setTimeout(() => {
                elements.toast.classList.remove('show');
                setTimeout(() => {
                    elements.toast.classList.add('hidden');
                }, 300);
            }, 3000);
        }
        
        // ============================
        // INITIALIZE PLATFORM
        // ============================
        document.addEventListener('DOMContentLoaded', initPlatform);
        
        // Make functions globally available for HTML onclick handlers
        window.switchView = switchView;
        window.toggleLike = toggleLike;
        window.toggleDislike = toggleDislike;
        window.shareVideo = shareVideo;
        window.addComment = addComment;
        window.showEmbedCode = showEmbedCode;
        window.closeEmbedModal = closeEmbedModal;
        window.copyEmbedCode = copyEmbedCode;
        window.handleGoogleLogin = handleGoogleLogin;
    </script>
</body>
</html>
